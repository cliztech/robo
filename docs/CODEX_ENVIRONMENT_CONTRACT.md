# CODEX Environment Contract

This document defines the runtime environment variable contract for DGN-DJ/RoboDJ across local development, Codex container sessions, and deployed environments.

For lifecycle governance and rotation procedures, see [Secret Lifecycle Policy](SECRET_LIFECYCLE_POLICY.md) and [Key Rotation Runbook](../config/KEY_ROTATION.md).

## 1) Required Variables by Context

### Canonical required secrets

- `ROBODJ_SECRET_KEY`
- `ROBODJ_SECRET_V2_KEY`

Optional metadata variables:

- `ROBODJ_SECRET_KEY_EXPIRES_AT`
- `ROBODJ_SECRET_V2_KEY_EXPIRES_AT`

`*_EXPIRES_AT` values should use ISO-8601 UTC timestamps (example: `2026-03-01T00:00:00Z`).

### Context matrix

| Context | `ROBODJ_SECRET_KEY` | `ROBODJ_SECRET_V2_KEY` | Expiry vars (`*_EXPIRES_AT`) | Local fallback files allowed | Notes |
| --- | --- | --- | --- | --- | --- |
| `local-dev` | Required | Required | Optional but recommended | Yes (`config/secret.key`, `config/secret_v2.key`) | Prefer env vars even in dev; fallback is for offline/break-glass developer workflows. |
| `codex-container` | Required | Required | Optional | Conditionally allowed (see decision table) | CI-like validation should prefer env-only mode. |
| `staging` | Required | Required | Optional but recommended | No (default) | Inject from secret manager at runtime. |
| `prod` | Required | Required | Recommended (strongly) | No | Must fail closed when keys are missing/invalid/expired. |

## 2) Platform-Provided Variables That May Appear

The following variables can appear in Codex/hosted environments but are **not** application secrets.

| Variable family | Examples | App dependency | Handling guidance |
| --- | --- | --- | --- |
| Codex platform vars (`CODEX_*`) | `CODEX_HOME`, `CODEX_SESSION_ID` | No direct runtime dependency | Treat as infrastructure metadata only; never use as auth/crypto input. |
| Proxy vars | `HTTP_PROXY`, `HTTPS_PROXY`, `NO_PROXY` | Optional/indirect | Only used when outbound networking requires a proxy; app should still boot without them unless external calls are required. |
| Standard process/env vars | `PATH`, `HOME`, `TMPDIR` | Indirect | Runtime environment support only; not part of RoboDJ secret contract. |

### Dependency statement

RoboDJ depends on `ROBODJ_SECRET_KEY` and `ROBODJ_SECRET_V2_KEY` for startup integrity checks and secure runtime behavior. `CODEX_*` and proxy variables are platform concerns, not security primitives for the app.

## 3) Source of Truth by Variable

| Variable | Source of truth | Fallback | How set |
| --- | --- | --- | --- |
| `ROBODJ_SECRET_KEY` | Secret manager / deployment environment injection | `config/secret.key` (local-dev or approved break-glass only) | Provisioned out-of-band; read at startup. |
| `ROBODJ_SECRET_V2_KEY` | Secret manager / deployment environment injection | `config/secret_v2.key` (local-dev or approved break-glass only) | Provisioned out-of-band; read at startup. |
| `ROBODJ_SECRET_KEY_EXPIRES_AT` | Secret manager metadata or release automation | None | Optional metadata used for startup warning/fail logic. |
| `ROBODJ_SECRET_V2_KEY_EXPIRES_AT` | Secret manager metadata or release automation | None | Optional metadata used for startup warning/fail logic. |
| `CODEX_*` vars | Codex platform runtime | None | Generated by host runtime; do not mirror into app config. |
| Proxy vars | Host/container runtime | None | Supplied by infrastructure when needed. |

## 4) Never-Log Policy (with Redaction Examples)

### Never log

- Raw values for:
  - `ROBODJ_SECRET_KEY`
  - `ROBODJ_SECRET_V2_KEY`
  - any future `*_SECRET_*`, `*_TOKEN*`, `*_KEY*` variables
- Contents of `config/secret.key` and `config/secret_v2.key`
- Derived key material (hashes used for key verification should also be treated as sensitive unless explicitly designed for disclosure)

### Required logging behavior

- Log only presence/validity state (`present`, `missing`, `invalid-format`, `expired`).
- Use stable, non-sensitive context in errors (environment name, check name, timestamp).
- Redact values before emitting exceptions, traces, audit messages, screenshots, or CI logs.

### Redaction examples

```text
# Bad
ALERT: ROBODJ_SECRET_KEY=4v8nA...<full secret>

# Good
ALERT: ROBODJ_SECRET_KEY status=present format=valid

# Bad
Loaded config/secret_v2.key value: 8f7d...

# Good
Loaded config/secret_v2.key (bytes=128) [value redacted]
```

## 5) Decision Table: Local Fallback Files Allowed vs Forbidden

| Scenario | Fallback files (`config/secret.key`, `config/secret_v2.key`) | Reason |
| --- | --- | --- |
| Developer running app locally without secret-manager access | Allowed | Supports local onboarding and offline testing. |
| Codex container session for docs-only work | Allowed but unnecessary | App runtime may not be invoked; env injection preferred if checks are run. |
| Codex container running validation with `--require-env-only` | Forbidden | Validation explicitly enforces environment-only source. |
| Staging deployment | Forbidden | Must reflect production-like secret delivery controls. |
| Production deployment | Forbidden | Source-of-truth must be secret manager + runtime injection. |
| Break-glass recovery approved by operators/security | Temporarily allowed | Time-boxed exception; rotate and return to env-only after recovery. |

## 6) Operational Notes

- Startup checks should fail closed for missing, invalid, or expired required secrets.
- Rotation and ownership policies are defined in [Secret Lifecycle Policy](SECRET_LIFECYCLE_POLICY.md).
- Operator procedures, including emergency handling, are in [config/KEY_ROTATION.md](../config/KEY_ROTATION.md).
