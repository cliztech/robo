name: CodeQL

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "17 4 * * 0"

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [actions, javascript-typescript, python]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: security-extended

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: /language:${{ matrix.language }}

  severity-gate:
    name: Severity gate (high/critical)
    runs-on: ubuntu-latest
    needs: analyze
    if: github.event_name != 'schedule'
    permissions:
      contents: read
      security-events: read

    steps:
      - name: Block on open high/critical CodeQL alerts for current ref
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const ref = context.sha;
            const blockingSeverities = new Set(["high", "critical"]);

            const alerts = await github.paginate(
              github.rest.codeScanning.listAlertsForRepo,
              {
                owner,
                repo,
                state: "open",
                ref,
                tool_name: "CodeQL",
                per_page: 100,
              },
            );

            const blockingAlerts = alerts.filter((alert) =>
              blockingSeverities.has((alert.rule?.security_severity_level || "").toLowerCase()),
            );

            if (blockingAlerts.length > 0) {
              core.error(`Blocking due to ${blockingAlerts.length} open high/critical CodeQL alert(s) on ${ref}.`);
              for (const alert of blockingAlerts.slice(0, 20)) {
                core.error(
                  `- [${(alert.rule?.security_severity_level || "n/a").toUpperCase()}] ${alert.rule?.id || "unknown-rule"} at ${alert.most_recent_instance?.location?.path || "unknown-path"}`,
                );
              }
              core.setFailed("CodeQL severity gate failed (high/critical). Triage or dismiss alerts before merge.");
              return;
            }

            core.info(`CodeQL severity gate passed for ${ref}: no open high/critical alerts.`);
