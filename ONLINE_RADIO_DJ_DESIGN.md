# Online Radio DJ - System Design Document

## 1. Executive Summary
The **Online Radio DJ** is an autonomous, AI-driven internet radio station platform. It replaces legacy desktop automation tools (like RoboDJ) with a modern, web-based, cloud-native architecture. It integrates seamlessly with the "AI Music Agents" ecosystem to broadcast AI-generated music alongside human-curated tracks, hosted by dynamic AI personalities.

## 2. Architecture Overview

### A. Core Components
1.  **Frontend (Next.js)**:
    -   **Dashboard**: Manage schedules, playlists, and AI host personalities.
    -   **Studio View**: Real-time visualizer of the broadcast queue and audio levels.
    -   **Public Player**: Embeddable web player for listeners.
2.  **Backend (Python FastAPI)**:
    -   **Scheduler Engine**: Determines what plays next (Music vs. Talk).
    -   **Content Manager**: CRUD for Tracks, Prompts, and Ad/Promo spots.
    -   **Agent Orchestrator**: Manages the "DJ Agent" lifecycle.
3.  **Audio Pipeline (Python/FFmpeg/Liquidsoap)**:
    -   **Streamer**: Generates the continuous audio stream (Icecast/HLS).
    -   **Mixer**: Handles hit-point-aware transitions, beat-aware crossfades, hard cuts, ducking, and segment-level mastering.
    -   **Synthesizer**: Interfacing with TTS providers (ElevenLabs, OpenAI).

### B. Integration with AI Music Agents
-   **Source Material**: Automatically ingests tracks generated by the `Composer` and `Producer` agents.
-   **Metadata**: Reads rich metadata (Mood, BPM, Key, Genre) to inform DJ scripts and transitions.
-   **Live Interaction**: The DJ Agent can "interview" the Musician Agents about their new tracks.

## 3. Detailed Modules

### 3.1. The DJ Agent ("Host")
*A specialized agent responsible for the "Voice" of the station.*

-   **Persona Profile**:
    -   `Name`, `Backstory`, `VoiceID`, `Tone` (e.g., "Hype", "Chill", "NPR-style").
    -   `Knowledge Base`: Access to artist bios, song facts, weather, and news.
-   **Scripting Engine (LLM)**:
    -   Generates "Links" (speech between songs).
    -   **Input**: Previous Song, Next Song, Station ID, Current Time, Weather, Listener Requests.
    -   **Output**: Natural language script with SSML tags for emotional inflection.

### 3.2. Scheduler & Playlist Manager
*The "Brain" that decides the programming.*

-   **Clock Wheels**: Define templates for an hour (e.g., "Top of Hour ID" -> "Power Hit" -> "DJ Link" -> "New Release").
-   **Station Timezone**:
    -   Every station must define a canonical IANA timezone string (e.g., `America/New_York`, `Europe/Berlin`).
    -   All recurrence calculations are evaluated in station local time, then expanded into UTC for storage/playout.
-   **Recurrence Rules**:
    -   Clock wheels and shows support deterministic recurrence using RFC 5545 style rules (`RRULE`) plus optional include/exclude dates.
    -   Minimum support: `FREQ`, `INTERVAL`, `BYDAY`, `BYHOUR`, `BYMINUTE`, `UNTIL`, `COUNT`, `WKST`, `RDATE`, `EXDATE`.
    -   For overlapping recurring blocks, scheduler resolves by explicit `priority` (higher wins), then by most-specific rule (single date > recurring rule), then by earliest creation timestamp.
-   **DST Handling Policy**:
    -   `wall_clock_strict`: keep local wall-clock intent stable (e.g., "08:00 local" stays 08:00 across DST boundaries).
    -   `utc_strict`: keep UTC instant cadence stable (may shift displayed local hour at DST transitions).
    -   Default for radio scheduling is `wall_clock_strict`.
    -   Non-existent local times (spring-forward gap) are shifted forward to the next valid local minute.
    -   Ambiguous local times (fall-back overlap) choose the first occurrence unless `dst_instance=second` is explicitly requested.
-   **Canonical Storage + Display Rules**:
    -   Canonical event instances in queue tables are always UTC timestamps.
    -   Source schedule definitions persist local intent (`local_start_time`, timezone, RRULE) for deterministic regeneration.
    -   UI always displays both local station time and UTC, with local station time as the primary presentation.
-   **Rules Engine**:
    -   *Artist Separation*: "Don't play the same artist within 60 minutes."
    -   *Tempo Flow*: "Gradually increase BPM from 6 PM to 9 PM."

### 3.3. Streaming Server
*The "Mouth" that broadcasts to the world.*

-   **Protocol**: HLS (HTTP Live Streaming) for low-latency web playback, or Icecast for compatibility.
-   **Transcoding**: Real-time encoding to AAC/MP3.
-   **Metadata Push**: Updates "Now Playing" info on the frontend.

## 4. Data Model (Draft Schema)

### StationSchedule
```json
{
  "id": "uuid",
  "station_id": "uuid",
  "timezone": "America/New_York",
  "dst_policy": "wall_clock_strict",
  "week_start": "MO",
  "display_time_mode": "local_primary",
  "version": 3,
  "effective_from_utc": "2026-01-01T00:00:00Z",
  "effective_to_utc": null
}
```

### ScheduleBlock (Clock Wheel / Show Definition)
```json
{
  "id": "uuid",
  "station_schedule_id": "uuid",
  "name": "Drive Time Show",
  "type": "show | clock_wheel",
  "priority": 100,
  "timezone": "America/New_York",
  "local_start_time": "17:00:00",
  "duration_minutes": 180,
  "recurrence_rule": "FREQ=WEEKLY;BYDAY=MO,TU,WE,TH,FR;BYHOUR=17;BYMINUTE=0",
  "rdate": ["2026-07-03T17:00:00"],
  "exdate": ["2026-12-25T17:00:00"],
  "dst_instance": "first",
  "content_template_id": "uuid"
}
```

### Tracks
```json
{
  "id": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
  "title": "Neon Nights",
  "artist": "AI Synthwave Collective",
  "duration": 245,
  "file_path": "s3://station-assets/tracks/neon_nights_v1.mp3",
  "publish_status": "published",
  "availability": "public",
  "intro_duration": 12,
  "outro_duration": 15,
  "bpm": 128,
  "energy": 0.8,
  "artwork_url": "https://cdn.station.fm/artwork/neon_nights.jpg",
  "is_explicit": false,
  "genre_tags": ["synthwave", "electronic"],
  "mood_tags": ["night_drive", "uplifting"],
  "language": "en",
  "lufs": -13.5,
  "peak_db": -1.0,
  "sample_rate": 44100,
  "codec": "mp3",
  "has_intro_marker": true,
  "has_outro_marker": true,
  "analytics": {
    "play_count": 1284,
    "like_count": 342,
    "skip_count": 57,
    "completion_rate": 0.91
  }
}
```

#### Example A: Minimal ingest record
```json
{
  "id": "5d2a0b1d-54f0-4974-85c4-57e7cd2f0ca7",
  "title": "Sunrise Loop",
  "artist": "LoFi Unit",
  "duration": 186,
  "file_path": "s3://ingest-bucket/tracks/2026/02/sunrise_loop.wav",
  "publish_status": "draft",
  "availability": "private"
}
```

#### Example B: Fully enriched published track
```json
{
  "id": "2f9c93e2-f131-41f3-8fc8-84d9f2c8f6d1",
  "title": "Neon Nights",
  "artist": "AI Synthwave Collective",
  "duration": 245,
  "file_path": "https://cdn.station.fm/audio/neon_nights_master.mp3",
  "publish_status": "published",
  "availability": "public",
  "intro_duration": 12,
  "outro_duration": 15,
  "bpm": 128,
  "energy": 0.8,
  "artwork_url": "https://cdn.station.fm/artwork/neon_nights.jpg",
  "is_explicit": false,
  "genre_tags": ["synthwave", "electronic", "retrowave"],
  "mood_tags": ["night_drive", "energetic", "futuristic"],
  "language": "en-US",
  "lufs": -13.7,
  "peak_db": -0.8,
  "sample_rate": 48000,
  "codec": "mp3",
  "has_intro_marker": true,
  "has_outro_marker": true,
  "analytics": {
    "play_count": 34981,
    "like_count": 9123,
    "skip_count": 1302,
    "completion_rate": 0.89
  }
  "codec": "aac | mp3 | flac | wav",
  "sample_rate_hz": 44100,
  "bitrate_kbps": 320,
  "channels": 2,
  "integrated_lufs": -13.7,
  "true_peak_dbtp": -1.0,
  "is_explicit": false,
  "content_rating": "clean | explicit | radio_edit",
  "isrc": "USRC17607839",
  "label": "Night Drive Records",
  "release_date": "2026-01-20",
  "artwork_url": "https://cdn.example.com/artwork/track-id.jpg",
  "waveform_url": "https://cdn.example.com/waveforms/track-id.json",
  "rights_status": "cleared | pending | blocked",
  "availability_status": "ready | geo_blocked | hold | takedown",
  "ingestion_status": "ingested | normalized | qa_failed | schedulable"
}
```

### Track Metadata Constraints for `schedulable`

A track may move to `ingestion_status = schedulable` only when all of the following are true:

- **Core metadata present**: `id`, `title`, `artist`, `duration`, `file_path`.
- **Ingestion metadata present**: `codec`, `sample_rate_hz`, `bitrate_kbps`, `channels`.
- **QA loudness metadata present**: `integrated_lufs`, `true_peak_dbtp`.
- **Compliance metadata present**: `is_explicit`, `content_rating`, `rights_status`, `availability_status`.
- **Catalog metadata present**: `release_date`.
- **Rights/availability gate**:
  - `rights_status = cleared`
  - `availability_status = ready`
- **Audio QA gate** (configurable policy defaults):
  - `integrated_lufs` between `-16` and `-12`
  - `true_peak_dbtp <= -1.0`

Optional-but-recommended metadata for discovery/player UX: `isrc`, `label`, `artwork_url`, `waveform_url`.

### Frontend Exposure (Admin + Player)

- **Admin track tables** should display:
  - `ingestion_status` (with badges)
  - `rights_status`
  - `availability_status`
  - `content_rating`
  - QA summary (`integrated_lufs`, `true_peak_dbtp`)
- **Admin filters** should include:
  - `ingestion_status` (especially `schedulable` vs non-schedulable)
  - `rights_status`
  - `availability_status`
  - `is_explicit` / `content_rating`
  - QA out-of-range toggle
- **Player-facing tables/cards** should expose:
  - `artwork_url` for cover display
  - `waveform_url` for waveform rendering
  - explicit badge based on `is_explicit` / `content_rating`

### BroadcastQueue
```json
{
  "id": "uuid",
  "scheduled_time": "2023-10-27T14:00:00Z",
  "scheduled_time_local": "2023-10-27T10:00:00-04:00",
  "station_timezone": "America/New_York",
  "item_type": "track | voice_link | jingle",
  "item_id": "uuid",
  "status": "pending | playing | played",
  "source_block_id": "uuid"
}
```

### Sample Deterministic Schedule Object (Recurring + Exceptions)
```json
{
  "station_id": "stn_001",
  "timezone": "America/New_York",
  "dst_policy": "wall_clock_strict",
  "generated_window": {
    "start_utc": "2026-11-23T00:00:00Z",
    "end_utc": "2026-12-01T00:00:00Z"
  },
  "blocks": [
    {
      "id": "blk_morning",
      "name": "Morning Clock Wheel",
      "type": "clock_wheel",
      "priority": 50,
      "local_start_time": "06:00:00",
      "duration_minutes": 240,
      "rrule": "FREQ=DAILY;BYHOUR=6;BYMINUTE=0",
      "template": ["top_id", "power", "dj_link", "recurrent_news"]
    },
    {
      "id": "blk_drive",
      "name": "Drive Time Live",
      "type": "show",
      "priority": 100,
      "local_start_time": "17:00:00",
      "duration_minutes": 180,
      "rrule": "FREQ=WEEKLY;BYDAY=MO,TU,WE,TH,FR;BYHOUR=17;BYMINUTE=0",
      "template": ["show_open", "music_rotation_a", "talk_break", "ads_local", "show_close"]
    }
  ],
  "exceptions": [
    {
      "id": "ex_thanksgiving",
      "date_local": "2026-11-26",
      "action": "replace_block",
      "target_block_id": "blk_drive",
      "replacement": {
        "id": "blk_holiday_special",
        "name": "Thanksgiving Special",
        "type": "show",
        "priority": 200,
        "local_start_time": "17:00:00",
        "duration_minutes": 240,
        "rrule": "FREQ=DAILY;COUNT=1",
        "template": ["holiday_open", "listener_dedications", "holiday_mix"]
      }
    },
    {
      "id": "ex_charity_remote",
      "date_local": "2026-11-28",
      "action": "insert_one_off",
      "one_off_block": {
        "id": "blk_charity_remote",
        "name": "Charity Remote Broadcast",
        "type": "show",
        "priority": 220,
        "local_start_time": "12:00:00",
        "duration_minutes": 120,
        "rrule": "FREQ=DAILY;COUNT=1",
        "template": ["remote_open", "live_interviews", "sponsor_mentions"]
      }
    }
  ],
  "resolved_instances": [
    {
      "block_id": "blk_drive",
      "start_local": "2026-11-25T17:00:00-05:00",
      "start_utc": "2026-11-25T22:00:00Z"
    },
    {
      "block_id": "blk_holiday_special",
      "start_local": "2026-11-26T17:00:00-05:00",
      "start_utc": "2026-11-26T22:00:00Z"
    },
    {
      "block_id": "blk_charity_remote",
      "start_local": "2026-11-28T12:00:00-05:00",
      "start_utc": "2026-11-28T17:00:00Z"
    }
  ]
}
```

### User
```json
{
  "id": "uuid",
  "email": "producer@station.fm",
  "display_name": "Night Shift Producer",
  "is_active": true,
  "role_ids": ["role_producer"],
  "last_login_at": "2026-02-12T09:15:00Z",
  "created_at": "2026-01-20T10:30:00Z",
  "updated_at": "2026-02-12T09:15:00Z"
}
```

### Role
```json
{
  "id": "role_operator",
  "name": "operator",
  "description": "Runs day-to-day playout operations",
  "permission_ids": [
    "queue.view",
    "queue.edit",
    "queue.reorder",
    "schedule.view",
    "host_persona.view"
  ],
  "created_at": "2026-01-20T10:30:00Z",
  "updated_at": "2026-02-12T09:15:00Z"
}
```

### Permission
```json
{
  "id": "schedule.publish",
  "resource": "schedule",
  "action": "publish",
  "description": "Publish a drafted schedule to the live programming timeline"
}
```

### Permission-Gated Actions (for API enforcement + frontend control states)
The backend MUST enforce permissions server-side and also return the current user's effective permission identifiers so the frontend can enable/disable controls deterministically.

| Action | Permission ID | Typical UI Controls |
|---|---|---|
| View broadcast queue | `queue.view` | Queue tab visibility |
| Edit queue entries (insert/remove/swap tracks) | `queue.edit` | Edit buttons, track replace modal |
| Reorder queue | `queue.reorder` | Drag-and-drop handle |
| View schedule drafts/live grid | `schedule.view` | Schedule page and timeline |
| Edit schedule drafts | `schedule.edit` | Save draft button, slot editor |
| Publish schedule to live | `schedule.publish` | Publish button + confirmation dialog |
| View host persona settings | `host_persona.view` | Persona panel visibility |
| Modify host persona (name/tone/voice/profile) | `host_persona.edit` | Persona form fields + save action |
| View API key metadata | `api_keys.view` | Integrations/settings page |
| Rotate API keys | `api_keys.rotate` | Rotate key button |
| Manage users and role assignments | `users.manage` | User admin section |
| View observability logs/audit trail | `audit_logs.view` | Logs dashboard |

### Minimal Role Set and Effective Permissions

| Role | Effective Permissions |
|---|---|
| `admin` | `queue.view`, `queue.edit`, `queue.reorder`, `schedule.view`, `schedule.edit`, `schedule.publish`, `host_persona.view`, `host_persona.edit`, `api_keys.view`, `api_keys.rotate`, `users.manage`, `audit_logs.view` |
| `producer` | `queue.view`, `queue.edit`, `queue.reorder`, `schedule.view`, `schedule.edit`, `schedule.publish`, `host_persona.view`, `host_persona.edit` |
| `operator` | `queue.view`, `queue.edit`, `queue.reorder`, `schedule.view`, `host_persona.view` |
| `viewer` | `queue.view`, `schedule.view`, `host_persona.view`, `api_keys.view` |

**Notes:**
- `admin` is the only minimal role that can rotate API keys and manage user-role assignments.
- `producer` can prepare and publish content but cannot manage users or secrets.
- `operator` can run live operations but cannot publish schedules or change host persona.
- `viewer` is read-only and intended for stakeholders/monitoring users.

## 5. Implementation Plan

### Phase 1: Core Engine (MVP)
-   [ ] Python script to generate a single "Show" (MP3 file) from a list of songs.
-   [ ] Basic LLM integration to announce song titles.
-   [ ] Simple crossfade mixing.

### Phase 2: Streaming & Scheduling
-   [ ] Implement Shoutcast/Icecast server connection.
-   [ ] Build the "Clock Wheel" scheduler logic.
-   [ ] Real-time weather/time injection.

### Phase 3: Web Integration
-   [ ] Admin Dashboard for uploading tracks and configuring DJ.
-   [ ] Public Player with "Now Playing" data.

## 6. Technology Stack Recommendations
-   **Language**: Python 3.11+ (Backend), TypeScript (Frontend).
-   **Audio Processing**: `pydub` (simple) or `ffmpeg-python` (complex).
-   **Streaming**: `Liquidsoap` (industry standard for radio automation) or custom FFmpeg stream.
-   **Database**: PostgreSQL (robustness) or SQLite (simplicity).
-   **AI**: LangChain (orchestration), OpenAI/Anthropic (LLM), ElevenLabs (TTS).

## 7. Audio Pipeline Upgrade Specification

### 7.1 Processing Chain (per rendered segment)

All output segments (music sweeps, voice links, promos, two-voice conversations) follow a deterministic mastering chain:

1. **Loudness normalization (LUFS)**
   - Analyze integrated loudness and true peak.
   - Normalize to preset target (format-dependent, see 7.2).
2. **Multiband compression**
   - 3- or 4-band split to stabilize tonal balance and perceived loudness.
   - Independent thresholds/ratios for low, mid, high bands.
3. **Limiter (true-peak safety)**
   - Final brickwall limiter to prevent clipping after codec conversion.
4. **Stereo enhancement (optional)**
   - Enabled per format/preset.
   - Apply mid/side widening with mono compatibility guardrails.
5. **De-esser for voice content**
   - Voice-only or voice-dominant segments.
   - Frequency-focused reduction of sibilance before final limiting.

> Implementation note: chain modules should be idempotent and configurable with profile-level overrides.

### 7.2 Per-Format Processing Presets

Define station-format defaults, then allow show-level overrides.

| Format | Target LUFS | Limiter Ceiling | Compression Character | Stereo Enhance | De-esser Intensity |
|---|---:|---:|---|---|---|
| **CHR** | -9 LUFS | -1.0 dBTP | Aggressive/punchy | On (moderate) | Medium |
| **Talk** | -16 LUFS | -2.0 dBTP | Speech-first, transparent | Off | High |
| **Chill** | -14 LUFS | -1.5 dBTP | Gentle/glue | On (light) | Low-Medium |
| **Classic Hits** | -12 LUFS | -1.2 dBTP | Medium density, warm | On (light-moderate) | Medium |

Preset object shape (example):

```json
{
  "format": "chr",
  "loudness": { "target_lufs": -9, "max_true_peak_dbtp": -1.0 },
  "multiband": {
    "bands": [
      { "name": "low", "threshold_db": -24, "ratio": 3.0 },
      { "name": "mid", "threshold_db": -20, "ratio": 2.5 },
      { "name": "high", "threshold_db": -18, "ratio": 2.0 }
    ]
  },
  "limiter": { "ceiling_dbtp": -1.0, "lookahead_ms": 3 },
  "stereo_enhancement": { "enabled": true, "width_percent": 115 },
  "de_esser": { "enabled": true, "freq_hz": 6500, "max_reduction_db": 4 }
}
```

### 7.3 Transition Intelligence

Upgrade transitions from timeline-only crossfades to analysis-driven decisions:

1. **Intro/outro hit-point awareness**
   - Detect/ingest markers (`intro_start`, `vocal_start`, `outro_start`, `cold_end`).
   - Schedule voice links into intro windows where available.
2. **Beat-aware crossfades (BPM-compatible)**
   - If BPM delta and phase confidence are within tolerance, align phrase boundaries.
   - Use bar-length fade curves (e.g., 4-beat or 8-beat) instead of fixed seconds.
3. **Hard cut fallback (incompatible tracks)**
   - Trigger when tempo/key/energy mismatch exceeds configured bounds.
   - Cut at transient-safe boundaries to avoid clicks.

Transition decision policy (high-level):

```text
if intro/outro windows overlap with safe margin:
    if bpm_compatible && beat_confidence >= threshold:
        use beat-aware crossfade
    else:
        use timed hit-point crossfade
else:
    use hard cut fallback
```

### 7.4 Auto-Duck Profiles

Add explicit ducking profiles selected by segment type:

1. **Speech-over-bed**
   - Fast attack, medium release.
   - Typical gain reduction: -8 to -12 dB.
   - Keep bed presence while maximizing intelligibility.
2. **Two-voice conversation**
   - Deeper bed reduction during overlaps.
   - Optional speaker-priority sidechain (active speaker gets less masking).
   - Typical gain reduction: -10 to -16 dB during dual speech.

Profile fields:
- `attack_ms`, `release_ms`, `hold_ms`
- `min_duck_db`, `max_duck_db`
- `noise_gate_threshold_db` (to avoid pumping)
- `dual_voice_extra_duck_db`

### 7.5 QA Analyzer (Automated Audio Validation)

Run QA checks post-render and before playout handoff.

Detection goals:
- **Clipping**: true-peak overs above threshold.
- **Over-compression**: low crest factor / low short-term loudness variance.
- **Silence anomalies**: unexpected long silence blocks.
- **Abrupt cuts**: discontinuity spikes at segment boundaries.

Output:
- `pass | warn | fail` status per check.
- Severity score and human-readable diagnostics.
- Suggested remediation (e.g., "increase fade length", "lower limiter drive").

### 7.6 Segment Technical Metadata for Diagnostics

Persist technical metadata for every rendered segment to support QA, debugging, and model tuning.

Recommended fields:

```json
{
  "segment_id": "uuid",
  "segment_type": "voice_link | track_transition | promo | conversation",
  "preset": "talk",
  "input": {
    "track_a_id": "uuid",
    "track_b_id": "uuid",
    "voice_asset_ids": ["uuid"]
  },
  "analysis": {
    "integrated_lufs": -14.2,
    "short_term_lufs_max": -10.1,
    "true_peak_dbtp": -1.1,
    "crest_factor_db": 7.4,
    "dynamic_range_lu": 5.8,
    "detected_bpm_a": 124,
    "detected_bpm_b": 126,
    "transition_type": "beat_crossfade",
    "duck_profile": "two_voice_conversation"
  },
  "qa": {
    "status": "warn",
    "checks": [
      { "name": "abrupt_cuts", "status": "pass" },
      { "name": "over_compression", "status": "warn", "score": 0.72 }
    ]
  },
  "render": {
    "engine_version": "audio-pipeline-2.0.0",
    "rendered_at": "2026-02-12T20:15:00Z",
    "duration_ms": 42150
  }
}
```

Storage options:
- `segment_audio_diagnostics` table in PostgreSQL for queryable history.
- Optional JSON sidecar file for each exported asset in object storage.

### 7.7 Rollout Approach

1. Ship new pipeline behind a feature flag (`audio_pipeline_v2_enabled`).
2. Run A/B renders (v1 vs v2) for selected hours.
3. Compare QA analyzer outputs and human producer feedback.
4. Promote per-format presets incrementally (Talk first, then music formats).
