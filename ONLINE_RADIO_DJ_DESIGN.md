# Online Radio DJ - System Design Document

## 1. Executive Summary
The **Online Radio DJ** is an autonomous, AI-driven internet radio station platform. It replaces legacy desktop automation tools (like RoboDJ) with a modern, web-based, cloud-native architecture. It integrates seamlessly with the "AI Music Agents" ecosystem to broadcast AI-generated music alongside human-curated tracks, hosted by dynamic AI personalities.

## 2. Architecture Overview

### A. Core Components
1.  **Frontend (Next.js)**:
    -   **Dashboard**: Manage schedules, playlists, and AI host personalities.
    -   **Studio View**: Real-time visualizer of the broadcast queue and audio levels.
    -   **Public Player**: Embeddable web player for listeners.
2.  **Backend (Python FastAPI)**:
    -   **Scheduler Engine**: Determines what plays next (Music vs. Talk).
    -   **Content Manager**: CRUD for Tracks, Prompts, and Ad/Promo spots.
    -   **Agent Orchestrator**: Manages the "DJ Agent" lifecycle.
3.  **Audio Pipeline (Python/FFmpeg/Liquidsoap)**:
    -   **Streamer**: Generates the continuous audio stream (Icecast/HLS).
    -   **Mixer**: Handles crossfades, ducking (lowering music volume during speech), and FX.
    -   **Synthesizer**: Interfacing with TTS providers (ElevenLabs, OpenAI).

### B. Integration with AI Music Agents
-   **Source Material**: Automatically ingests tracks generated by the `Composer` and `Producer` agents.
-   **Metadata**: Reads rich metadata (Mood, BPM, Key, Genre) to inform DJ scripts and transitions.
-   **Live Interaction**: The DJ Agent can "interview" the Musician Agents about their new tracks.

## 3. Detailed Modules

### 3.1. The DJ Agent ("Host")
*A specialized agent responsible for the "Voice" of the station.*

-   **Persona Profile**:
    -   `Name`, `Backstory`, `VoiceID`, `Tone` (e.g., "Hype", "Chill", "NPR-style").
    -   `Knowledge Base`: Access to artist bios, song facts, weather, and news.
-   **Scripting Engine (LLM)**:
    -   Generates "Links" (speech between songs).
    -   **Input**: Previous Song, Next Song, Station ID, Current Time, Weather, Listener Requests.
    -   **Output**: Natural language script with SSML tags for emotional inflection.

### 3.2. Scheduler & Playlist Manager
*The "Brain" that decides the programming.*

-   **Clock Wheels**: Define templates for an hour (e.g., "Top of Hour ID" -> "Power Hit" -> "DJ Link" -> "New Release").
-   **Rules Engine**:
    -   *Artist Separation*: "Don't play the same artist within 60 minutes."
    -   *Tempo Flow*: "Gradually increase BPM from 6 PM to 9 PM."

### 3.3. Streaming Server
*The "Mouth" that broadcasts to the world.*

-   **Protocol**: HLS (HTTP Live Streaming) for low-latency web playback, or Icecast for compatibility.
-   **Transcoding**: Real-time encoding to AAC/MP3.
-   **Metadata Push**: Updates "Now Playing" info on the frontend.

## 4. Data Model (Draft Schema)

### Tracks
```json
{
  "id": "uuid",
  "title": "Neon Nights",
  "artist": "AI Synthwave Collective",
  "duration": 245,
  "intro_duration": 12,
  "outro_duration": 15,
  "file_path": "s3://...",
  "bpm": 128,
  "energy": 0.8
}
```

### BroadcastQueue
```json
{
  "id": "uuid",
  "scheduled_time": "2023-10-27T14:00:00Z",
  "item_type": "track | voice_link | jingle",
  "item_id": "uuid",
  "status": "pending | playing | played"
}
```

### User
```json
{
  "id": "uuid",
  "email": "producer@station.fm",
  "display_name": "Night Shift Producer",
  "is_active": true,
  "role_ids": ["role_producer"],
  "last_login_at": "2026-02-12T09:15:00Z",
  "created_at": "2026-01-20T10:30:00Z",
  "updated_at": "2026-02-12T09:15:00Z"
}
```

### Role
```json
{
  "id": "role_operator",
  "name": "operator",
  "description": "Runs day-to-day playout operations",
  "permission_ids": [
    "queue.view",
    "queue.edit",
    "queue.reorder",
    "schedule.view",
    "host_persona.view"
  ],
  "created_at": "2026-01-20T10:30:00Z",
  "updated_at": "2026-02-12T09:15:00Z"
}
```

### Permission
```json
{
  "id": "schedule.publish",
  "resource": "schedule",
  "action": "publish",
  "description": "Publish a drafted schedule to the live programming timeline"
}
```

### Permission-Gated Actions (for API enforcement + frontend control states)
The backend MUST enforce permissions server-side and also return the current user's effective permission identifiers so the frontend can enable/disable controls deterministically.

| Action | Permission ID | Typical UI Controls |
|---|---|---|
| View broadcast queue | `queue.view` | Queue tab visibility |
| Edit queue entries (insert/remove/swap tracks) | `queue.edit` | Edit buttons, track replace modal |
| Reorder queue | `queue.reorder` | Drag-and-drop handle |
| View schedule drafts/live grid | `schedule.view` | Schedule page and timeline |
| Edit schedule drafts | `schedule.edit` | Save draft button, slot editor |
| Publish schedule to live | `schedule.publish` | Publish button + confirmation dialog |
| View host persona settings | `host_persona.view` | Persona panel visibility |
| Modify host persona (name/tone/voice/profile) | `host_persona.edit` | Persona form fields + save action |
| View API key metadata | `api_keys.view` | Integrations/settings page |
| Rotate API keys | `api_keys.rotate` | Rotate key button |
| Manage users and role assignments | `users.manage` | User admin section |
| View observability logs/audit trail | `audit_logs.view` | Logs dashboard |

### Minimal Role Set and Effective Permissions

| Role | Effective Permissions |
|---|---|
| `admin` | `queue.view`, `queue.edit`, `queue.reorder`, `schedule.view`, `schedule.edit`, `schedule.publish`, `host_persona.view`, `host_persona.edit`, `api_keys.view`, `api_keys.rotate`, `users.manage`, `audit_logs.view` |
| `producer` | `queue.view`, `queue.edit`, `queue.reorder`, `schedule.view`, `schedule.edit`, `schedule.publish`, `host_persona.view`, `host_persona.edit` |
| `operator` | `queue.view`, `queue.edit`, `queue.reorder`, `schedule.view`, `host_persona.view` |
| `viewer` | `queue.view`, `schedule.view`, `host_persona.view`, `api_keys.view` |

**Notes:**
- `admin` is the only minimal role that can rotate API keys and manage user-role assignments.
- `producer` can prepare and publish content but cannot manage users or secrets.
- `operator` can run live operations but cannot publish schedules or change host persona.
- `viewer` is read-only and intended for stakeholders/monitoring users.

## 5. Implementation Plan

### Phase 1: Core Engine (MVP)
-   [ ] Python script to generate a single "Show" (MP3 file) from a list of songs.
-   [ ] Basic LLM integration to announce song titles.
-   [ ] Simple crossfade mixing.

### Phase 2: Streaming & Scheduling
-   [ ] Implement Shoutcast/Icecast server connection.
-   [ ] Build the "Clock Wheel" scheduler logic.
-   [ ] Real-time weather/time injection.

### Phase 3: Web Integration
-   [ ] Admin Dashboard for uploading tracks and configuring DJ.
-   [ ] Public Player with "Now Playing" data.

## 6. Technology Stack Recommendations
-   **Language**: Python 3.11+ (Backend), TypeScript (Frontend).
-   **Audio Processing**: `pydub` (simple) or `ffmpeg-python` (complex).
-   **Streaming**: `Liquidsoap` (industry standard for radio automation) or custom FFmpeg stream.
-   **Database**: PostgreSQL (robustness) or SQLite (simplicity).
-   **AI**: LangChain (orchestration), OpenAI/Anthropic (LLM), ElevenLabs (TTS).
