# Online Radio DJ - System Design Document

## 1. Executive Summary
The **Online Radio DJ** is an autonomous, AI-driven internet radio station platform. It replaces legacy desktop automation tools (like RoboDJ) with a modern, web-based, cloud-native architecture. It integrates seamlessly with the "AI Music Agents" ecosystem to broadcast AI-generated music alongside human-curated tracks, hosted by dynamic AI personalities.

## 2. Architecture Overview

### A. Core Components
1.  **Frontend (Next.js)**:
    -   **Dashboard**: Manage schedules, playlists, and AI host personalities.
    -   **Studio View**: Real-time visualizer of the broadcast queue and audio levels.
    -   **Public Player**: Embeddable web player for listeners.
2.  **Backend (Python FastAPI)**:
    -   **Scheduler Engine**: Determines what plays next (Music vs. Talk).
    -   **Content Manager**: CRUD for Tracks, Prompts, and Ad/Promo spots.
    -   **Agent Orchestrator**: Manages the "DJ Agent" lifecycle.
3.  **Audio Pipeline (Python/FFmpeg/Liquidsoap)**:
    -   **Streamer**: Generates the continuous audio stream (Icecast/HLS).
    -   **Mixer**: Handles crossfades, ducking (lowering music volume during speech), and FX.
    -   **Synthesizer**: Interfacing with TTS providers (ElevenLabs, OpenAI).

### B. Integration with AI Music Agents
-   **Source Material**: Automatically ingests tracks generated by the `Composer` and `Producer` agents.
-   **Metadata**: Reads rich metadata (Mood, BPM, Key, Genre) to inform DJ scripts and transitions.
-   **Live Interaction**: The DJ Agent can "interview" the Musician Agents about their new tracks.

## 3. Detailed Modules

### 3.1. The DJ Agent ("Host")
*A specialized agent responsible for the "Voice" of the station.*

-   **Persona Profile**:
    -   `Name`, `Backstory`, `VoiceID`, `Tone` (e.g., "Hype", "Chill", "NPR-style").
    -   `Knowledge Base`: Access to artist bios, song facts, weather, and news.
-   **Scripting Engine (LLM)**:
    -   Generates "Links" (speech between songs).
    -   **Input**: Previous Song, Next Song, Station ID, Current Time, Weather, Listener Requests.
    -   **Output**: Natural language script with SSML tags for emotional inflection.

### 3.2. Scheduler & Playlist Manager
*The "Brain" that decides the programming.*

-   **Clock Wheels**: Define templates for an hour (e.g., "Top of Hour ID" -> "Power Hit" -> "DJ Link" -> "New Release").
-   **Rules Engine**:
    -   *Artist Separation*: "Don't play the same artist within 60 minutes."
    -   *Tempo Flow*: "Gradually increase BPM from 6 PM to 9 PM."

### 3.3. Streaming Server
*The "Mouth" that broadcasts to the world.*

-   **Protocol**: HLS (HTTP Live Streaming) for low-latency web playback, or Icecast for compatibility.
-   **Transcoding**: Real-time encoding to AAC/MP3.
-   **Metadata Push**: Updates "Now Playing" info on the frontend.

## 4. Data Model (Draft Schema)

### StationConfig
*Used by Dashboard settings, Studio context, and Public Player branding.*

**Required fields**
- `id`
- `slug`
- `display_name`
- `timezone`
- `branding`
- `stream_urls`

**Optional fields**
- `default_language`
- `default_locale`
- `support_email`
- `social_links`
- `fallback_track_id` *(FK -> `Tracks.id`)*
- `active_clock_wheel_id` *(FK -> `ClockWheel.id`)*

```json
{
  "id": "station_01HZN9YQ9G0M6Q",
  "slug": "neon-fm",
  "display_name": "Neon FM",
  "timezone": "America/New_York",
  "branding": {
    "logo_url": "https://cdn.example.com/branding/neonfm/logo.svg",
    "primary_color": "#7A3CFF",
    "accent_color": "#00E5FF",
    "tagline": "Future sounds, live now"
  },
  "stream_urls": {
    "hls": "https://stream.example.com/neonfm/index.m3u8",
    "icecast_mp3": "https://stream.example.com/neonfm.mp3",
    "fallback_preview": "https://cdn.example.com/previews/offline-loop.mp3"
  },
  "default_language": "en",
  "default_locale": "en-US",
  "support_email": "support@neonfm.example",
  "social_links": {
    "x": "https://x.com/neonfm",
    "instagram": "https://instagram.com/neonfm"
  },
  "fallback_track_id": "trk_62f8a2b6",
  "active_clock_wheel_id": "clock_7am_drive"
}
```

### ShowBlock + ClockWheel
*Defines repeatable schedule templates and concrete blocks visible in Dashboard and Studio View.*

**Required fields (ClockWheel)**
- `id`
- `station_id` *(FK -> `StationConfig.id`)*
- `name`
- `hour_mask`
- `segments`

**Optional fields (ClockWheel)**
- `daypart`
- `valid_from`
- `valid_to`
- `constraints`

**Required fields (ShowBlock)**
- `id`
- `station_id` *(FK -> `StationConfig.id`)*
- `clock_wheel_id` *(FK -> `ClockWheel.id`)*
- `starts_at`
- `duration_sec`
- `status`

**Optional fields (ShowBlock)**
- `host_persona_id` *(FK -> `HostPersona.id`)*
- `resolved_queue_item_ids` *(FK array -> `BroadcastQueue.id`)*

```json
{
  "clock_wheel": {
    "id": "clock_7am_drive",
    "station_id": "station_01HZN9YQ9G0M6Q",
    "name": "Morning Drive",
    "daypart": "morning",
    "hour_mask": [7, 8, 9],
    "valid_from": "2026-01-01",
    "valid_to": null,
    "segments": [
      {
        "offset_sec": 0,
        "slot_type": "station_id",
        "duration_sec": 10
      },
      {
        "offset_sec": 10,
        "slot_type": "music_power",
        "duration_sec": 240,
        "track_id": "trk_62f8a2b6"
      },
      {
        "offset_sec": 250,
        "slot_type": "voice_link",
        "duration_sec": 40,
        "prompt_template_id": "tmpl_song_intro"
      },
      {
        "offset_sec": 290,
        "slot_type": "promo",
        "duration_sec": 30,
        "ad_inventory_id": "adinv_weekend_ticket_push"
      }
    ],
    "constraints": {
      "artist_separation_minutes": 60,
      "max_consecutive_talk_breaks": 2
    }
  },
  "show_block": {
    "id": "show_2026-02-12T07",
    "station_id": "station_01HZN9YQ9G0M6Q",
    "clock_wheel_id": "clock_7am_drive",
    "starts_at": "2026-02-12T07:00:00-05:00",
    "duration_sec": 3600,
    "status": "scheduled",
    "host_persona_id": "host_ava_nova",
    "resolved_queue_item_ids": [
      "queue_801",
      "queue_802",
      "queue_803"
    ]
  }
}
```

### HostPersona + VoiceProviderBinding
*Powers AI host management in Dashboard and real-time rendering in Studio View.*

**Required fields (HostPersona)**
- `id`
- `station_id` *(FK -> `StationConfig.id`)*
- `name`
- `tone_profile`
- `voice_binding`

**Optional fields (HostPersona)**
- `backstory`
- `default_prompt_template_id` *(FK -> `PromptTemplate.id`)*
- `knowledge_sources`
- `active`

**Required fields (VoiceProviderBinding)**
- `provider`
- `voice_id`
- `model`

**Optional fields (VoiceProviderBinding)**
- `style`
- `speaking_rate`
- `pitch`
- `stability`

```json
{
  "id": "host_ava_nova",
  "station_id": "station_01HZN9YQ9G0M6Q",
  "name": "Ava Nova",
  "backstory": "Former club resident turned AI tastemaker.",
  "tone_profile": ["energetic", "witty", "music-forward"],
  "default_prompt_template_id": "tmpl_song_intro",
  "knowledge_sources": ["music_catalog", "weather_api", "station_events"],
  "active": true,
  "voice_binding": {
    "provider": "elevenlabs",
    "voice_id": "21m00Tcm4TlvDq8ikWAM",
    "model": "eleven_multilingual_v2",
    "style": "radio",
    "speaking_rate": 1.02,
    "pitch": 0,
    "stability": 0.55
  }
}
```

### PromptTemplate + RuntimeVariableBinding
*Backs script authoring in Dashboard and generated link text in Studio View.*

**Required fields (PromptTemplate)**
- `id`
- `station_id` *(FK -> `StationConfig.id`)*
- `name`
- `template_text`
- `variable_specs`

**Optional fields (PromptTemplate)**
- `persona_id` *(FK -> `HostPersona.id`)*
- `applies_to_slot_types`
- `safety_rules`
- `version`

**Required fields (RuntimeVariableBinding)**
- `template_id` *(FK -> `PromptTemplate.id`)*
- `queue_item_id` *(FK -> `BroadcastQueue.id`)*
- `bindings`

**Optional fields (RuntimeVariableBinding)**
- `source_track_id` *(FK -> `Tracks.id`)*
- `next_track_id` *(FK -> `Tracks.id`)*
- `listener_request_id`

```json
{
  "template": {
    "id": "tmpl_song_intro",
    "station_id": "station_01HZN9YQ9G0M6Q",
    "name": "Song Intro + Tease",
    "template_text": "Coming up next is {{next_track_title}} by {{next_track_artist}}. {{optional_weather_tag}} Stay with {{station_name}}.",
    "variable_specs": [
      {"name": "next_track_title", "required": true, "type": "string"},
      {"name": "next_track_artist", "required": true, "type": "string"},
      {"name": "optional_weather_tag", "required": false, "type": "string"},
      {"name": "station_name", "required": true, "type": "string"}
    ],
    "persona_id": "host_ava_nova",
    "applies_to_slot_types": ["voice_link", "top_of_hour"],
    "safety_rules": ["no_profanity", "no_medical_claims"],
    "version": 3
  },
  "runtime_binding": {
    "template_id": "tmpl_song_intro",
    "queue_item_id": "queue_802",
    "source_track_id": "trk_51f1a0d9",
    "next_track_id": "trk_62f8a2b6",
    "bindings": {
      "next_track_title": "Neon Nights",
      "next_track_artist": "AI Synthwave Collective",
      "optional_weather_tag": "Clear skies tonight in Brooklyn.",
      "station_name": "Neon FM"
    }
  }
}
```

### AdPromoInventory
*Feeds Dashboard campaign controls and scheduler placement decisions surfaced in Studio View.*

**Required fields**
- `id`
- `station_id` *(FK -> `StationConfig.id`)*
- `type`
- `title`
- `asset_uri`
- `duration_sec`
- `constraints`

**Optional fields**
- `priority`
- `campaign_window`
- `max_plays_per_hour`
- `target_show_block_ids` *(FK array -> `ShowBlock.id`)*
- `companion_track_id` *(FK -> `Tracks.id`)*
- `last_scheduled_queue_item_id` *(FK -> `BroadcastQueue.id`)*

```json
{
  "id": "adinv_weekend_ticket_push",
  "station_id": "station_01HZN9YQ9G0M6Q",
  "type": "promo",
  "title": "Weekend Festival Ticket Push",
  "asset_uri": "s3://station-assets/promos/weekend-fest-30s.wav",
  "duration_sec": 30,
  "constraints": {
    "min_minutes_between_plays": 45,
    "allowed_dayparts": ["morning", "afternoon"],
    "exclude_adjacent_slot_types": ["station_id"]
  },
  "priority": "high",
  "campaign_window": {
    "start": "2026-02-01T00:00:00Z",
    "end": "2026-02-28T23:59:59Z"
  },
  "max_plays_per_hour": 1,
  "target_show_block_ids": ["show_2026-02-12T07"],
  "companion_track_id": "trk_62f8a2b6",
  "last_scheduled_queue_item_id": "queue_803"
}
```

### PublicPlayerNowPlayingSnapshot
*Serves the Public Player with a listener-safe, low-latency now-playing payload.*

**Required fields**
- `station_id` *(FK -> `StationConfig.id`)*
- `generated_at`
- `stream_status`
- `now_playing`
- `up_next`

**Optional fields**
- `host`
- `recently_played`
- `public_message`
- `active_queue_item_id` *(FK -> `BroadcastQueue.id`)*

```json
{
  "station_id": "station_01HZN9YQ9G0M6Q",
  "generated_at": "2026-02-12T12:15:04Z",
  "stream_status": "live",
  "active_queue_item_id": "queue_802",
  "now_playing": {
    "queue_item_id": "queue_802",
    "item_type": "track",
    "track_id": "trk_62f8a2b6",
    "title": "Neon Nights",
    "artist": "AI Synthwave Collective",
    "started_at": "2026-02-12T12:13:10Z",
    "duration_sec": 245,
    "artwork_url": "https://cdn.example.com/artwork/trk_62f8a2b6.jpg"
  },
  "up_next": [
    {
      "queue_item_id": "queue_803",
      "item_type": "promo",
      "title": "Weekend Festival Ticket Push",
      "eta_sec": 38
    },
    {
      "queue_item_id": "queue_804",
      "item_type": "voice_link",
      "title": "Ava Nova break",
      "eta_sec": 68
    }
  ],
  "host": {
    "host_persona_id": "host_ava_nova",
    "name": "Ava Nova"
  },
  "recently_played": [
    {
      "queue_item_id": "queue_801",
      "track_id": "trk_51f1a0d9",
      "title": "Midnight Run",
      "artist": "Digital Skyline"
    }
  ],
  "public_message": "Vote for tonight's throwback on our app."
}
```

### Tracks
```json
{
  "id": "uuid",
  "title": "Neon Nights",
  "artist": "AI Synthwave Collective",
  "duration": 245,
  "intro_duration": 12,
  "outro_duration": 15,
  "file_path": "s3://...",
  "bpm": 128,
  "energy": 0.8
}
```

### BroadcastQueue
```json
{
  "id": "uuid",
  "scheduled_time": "2023-10-27T14:00:00Z",
  "item_type": "track | voice_link | jingle",
  "item_id": "uuid",
  "status": "pending | playing | played"
}
```

## 5. Implementation Plan

### Phase 1: Core Engine (MVP)
-   [ ] Python script to generate a single "Show" (MP3 file) from a list of songs.
-   [ ] Basic LLM integration to announce song titles.
-   [ ] Simple crossfade mixing.

### Phase 2: Streaming & Scheduling
-   [ ] Implement Shoutcast/Icecast server connection.
-   [ ] Build the "Clock Wheel" scheduler logic.
-   [ ] Real-time weather/time injection.

### Phase 3: Web Integration
-   [ ] Admin Dashboard for uploading tracks and configuring DJ.
-   [ ] Public Player with "Now Playing" data.

## 6. Technology Stack Recommendations
-   **Language**: Python 3.11+ (Backend), TypeScript (Frontend).
-   **Audio Processing**: `pydub` (simple) or `ffmpeg-python` (complex).
-   **Streaming**: `Liquidsoap` (industry standard for radio automation) or custom FFmpeg stream.
-   **Database**: PostgreSQL (robustness) or SQLite (simplicity).
-   **AI**: LangChain (orchestration), OpenAI/Anthropic (LLM), ElevenLabs (TTS).
