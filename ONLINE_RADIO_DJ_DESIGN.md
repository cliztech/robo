# Online Radio DJ - System Design Document

## 1. Executive Summary
The **Online Radio DJ** is an autonomous, AI-driven internet radio station platform. It replaces legacy desktop automation tools (like RoboDJ) with a modern, web-based, cloud-native architecture. It integrates seamlessly with the "AI Music Agents" ecosystem to broadcast AI-generated music alongside human-curated tracks, hosted by dynamic AI personalities.

## 2. Architecture Overview

### A. Core Components
1.  **Frontend (Next.js)**:
    -   **Dashboard**: Manage schedules, playlists, and AI host personalities.
    -   **Studio View**: Real-time visualizer of the broadcast queue and audio levels.
    -   **Public Player**: Embeddable web player for listeners.
2.  **Backend (Python FastAPI)**:
    -   **Scheduler Engine**: Determines what plays next (Music vs. Talk).
    -   **Content Manager**: CRUD for Tracks, Prompts, and Ad/Promo spots.
    -   **Agent Orchestrator**: Manages the "DJ Agent" lifecycle.
3.  **Audio Pipeline (Python/FFmpeg/Liquidsoap)**:
    -   **Streamer**: Generates the continuous audio stream (Icecast/HLS).
    -   **Mixer**: Handles crossfades, ducking (lowering music volume during speech), and FX.
    -   **Synthesizer**: Interfacing with TTS providers (ElevenLabs, OpenAI).

### B. Integration with AI Music Agents
-   **Source Material**: Automatically ingests tracks generated by the `Composer` and `Producer` agents.
-   **Metadata**: Reads rich metadata (Mood, BPM, Key, Genre) to inform DJ scripts and transitions.
-   **Live Interaction**: The DJ Agent can "interview" the Musician Agents about their new tracks.

## 3. Detailed Modules

### 3.1. The DJ Agent ("Host")
*A specialized agent responsible for the "Voice" of the station.*

-   **Persona Profile**:
    -   `Name`, `Backstory`, `VoiceID`, `Tone` (e.g., "Hype", "Chill", "NPR-style").
    -   `Knowledge Base`: Access to artist bios, song facts, weather, and news.
-   **Scripting Engine (LLM)**:
    -   Generates "Links" (speech between songs).
    -   **Input**: Previous Song, Next Song, Station ID, Current Time, Weather, Listener Requests.
    -   **Output**: Natural language script with SSML tags for emotional inflection.

### 3.2. Scheduler & Playlist Manager
*The "Brain" that decides the programming.*

-   **Clock Wheels**: Define templates for an hour (e.g., "Top of Hour ID" -> "Power Hit" -> "DJ Link" -> "New Release").
-   **Rules Engine**:
    -   *Artist Separation*: "Don't play the same artist within 60 minutes."
    -   *Tempo Flow*: "Gradually increase BPM from 6 PM to 9 PM."

### 3.3. Streaming Server
*The "Mouth" that broadcasts to the world.*

-   **Protocol**: HLS (HTTP Live Streaming) for low-latency web playback, or Icecast for compatibility.
-   **Transcoding**: Real-time encoding to AAC/MP3.
-   **Metadata Push**: Updates "Now Playing" info on the frontend.

## 4. Data Model (Draft Schema)

### Tracks
```json
{
  "id": "uuid",
  "title": "Neon Nights",
  "artist": "AI Synthwave Collective",
  "duration": 245,
  "intro_duration": 12,
  "outro_duration": 15,
  "file_path": "s3://...",
  "bpm": 128,
  "energy": 0.8
}
```

### BroadcastQueue
```json
{
  "id": "uuid",
  "scheduled_time": "2023-10-27T14:00:00Z",
  "item_type": "track | voice_link | jingle",
  "item_id": "uuid",
  "status": "pending | playing | played"
}
```

## 4.1 API Response & Query Contract

To keep frontend state management predictable across resources, all collection endpoints use a common envelope and query semantics.

### List response envelope

All `GET` list endpoints return:

```json
{
  "items": [],
  "page": 1,
  "page_size": 25,
  "total": 0
}
```

- `items`: Array of resource objects for the current slice.
- `page`: 1-based page index returned when using offset pagination.
- `page_size`: Number of items requested/returned per page.
- `total`: Total number of matching records after filtering (before paging).

### Error format

All non-2xx responses return a normalized error body:

```json
{
  "code": "VALIDATION_ERROR",
  "message": "One or more query parameters are invalid.",
  "details": {
    "field": "sort",
    "reason": "Unknown sort field: popularity"
  },
  "trace_id": "req_7f4db6c4aa3b4e57"
}
```

- `code`: Stable machine-readable error code.
- `message`: Human-readable summary safe for UI display.
- `details`: Structured context (optional but recommended).
- `trace_id`: Request correlation ID for logs/support.

### Sorting, filtering, and query syntax

- `sort`: Comma-separated fields; prefix with `-` for descending.
  - Example: `sort=-scheduled_time,title`
- `filter[field]`: Exact match by default.
  - Example: `filter[status]=pending`
- `filter[field][op]`: Operator-based filters when needed.
  - Supported ops: `eq`, `ne`, `gt`, `gte`, `lt`, `lte`, `in`, `contains`.
  - Example: `filter[energy][gte]=0.7`
- `q`: Full-text search against endpoint-defined searchable fields.
  - Example: `q=neon`

### Include/expand conventions

- `include`: Side-load related entities in top-level maps keyed by type.
  - Example: `include=artist,album`
  - Response extension pattern:
    ```json
    {
      "items": [],
      "included": {
        "artist": [],
        "album": []
      },
      "page": 1,
      "page_size": 25,
      "total": 0
    }
    ```
- `expand`: Inline embed related entities inside each item.
  - Example: `expand=track`
  - Use when the UI needs object traversal in a single normalized payload.
- Clients should not send both `include` and `expand` for the same relation in one request.

### Pagination policy (offset + cursor)

- **Default**: Offset pagination using `page` and `page_size`.
  - Recommended for admin grids and deterministic back-office lists.
- **Cursor mode**: Use `cursor` and `limit` for live/append-only feeds.
  - If `cursor` is provided, server ignores `page` and `page_size`.
  - Cursor response shape:
    ```json
    {
      "items": [],
      "page": null,
      "page_size": 50,
      "total": null,
      "next_cursor": "eyJzY2hlZHVsZWRfdGltZSI6IjIwMjYtMDUtMTVUMTg6MzA6MDBaIiwiaWQiOiIuLi4ifQ=="
    }
    ```
- Contract rule: offset responses must always include `total`; cursor responses may set `total` to `null`.

### Concrete examples

#### `GET /tracks`

Request:

```http
GET /tracks?page=1&page_size=20&sort=-energy,title&filter[genre]=synthwave&filter[duration][lte]=300&q=neon&include=artist
```

Response:

```json
{
  "items": [
    {
      "id": "trk_01HZX8P6Y8K57W3Q6M5T3Y4C2F",
      "title": "Neon Nights",
      "artist_id": "art_01HZX7QJ2A4W8F9X0M3Z5K1R7N",
      "genre": "synthwave",
      "duration": 245,
      "energy": 0.8
    }
  ],
  "included": {
    "artist": [
      {
        "id": "art_01HZX7QJ2A4W8F9X0M3Z5K1R7N",
        "name": "AI Synthwave Collective"
      }
    ]
  },
  "page": 1,
  "page_size": 20,
  "total": 134
}
```

#### `GET /broadcast-queue`

Request (offset mode):

```http
GET /broadcast-queue?page=2&page_size=25&sort=scheduled_time&filter[status]=pending&expand=track
```

Response (offset mode):

```json
{
  "items": [
    {
      "id": "bq_01HZXB7EYPPRMYW65AM7Q2CC3P",
      "scheduled_time": "2026-05-15T18:00:00Z",
      "item_type": "track",
      "item_id": "trk_01HZX8P6Y8K57W3Q6M5T3Y4C2F",
      "status": "pending",
      "track": {
        "id": "trk_01HZX8P6Y8K57W3Q6M5T3Y4C2F",
        "title": "Neon Nights",
        "duration": 245
      }
    }
  ],
  "page": 2,
  "page_size": 25,
  "total": 412
}
```

Request (cursor mode for live studio queue):

```http
GET /broadcast-queue?cursor=eyJzY2hlZHVsZWRfdGltZSI6IjIwMjYtMDUtMTVUMTg6MDA6MDBaIiwiaWQiOiJi..."&limit=50&sort=scheduled_time
```

Response (cursor mode):

```json
{
  "items": [
    {
      "id": "bq_01HZXB85QXW7R4T4K2VTW7M1YM",
      "scheduled_time": "2026-05-15T18:03:30Z",
      "item_type": "voice_link",
      "item_id": "vl_01HZXB81A95Q5SNYR6A6VWPJ3C",
      "status": "pending"
    }
  ],
  "page": null,
  "page_size": 50,
  "total": null,
  "next_cursor": "eyJzY2hlZHVsZWRfdGltZSI6IjIwMjYtMDUtMTVUMTg6MDM6MzBaIiwiaWQiOiJi..."
}
```

## 5. Implementation Plan

### Phase 1: Core Engine (MVP)
-   [ ] Python script to generate a single "Show" (MP3 file) from a list of songs.
-   [ ] Basic LLM integration to announce song titles.
-   [ ] Simple crossfade mixing.

### Phase 2: Streaming & Scheduling
-   [ ] Implement Shoutcast/Icecast server connection.
-   [ ] Build the "Clock Wheel" scheduler logic.
-   [ ] Real-time weather/time injection.

### Phase 3: Web Integration
-   [ ] Admin Dashboard for uploading tracks and configuring DJ.
-   [ ] Public Player with "Now Playing" data.

## 6. Technology Stack Recommendations
-   **Language**: Python 3.11+ (Backend), TypeScript (Frontend).
-   **Audio Processing**: `pydub` (simple) or `ffmpeg-python` (complex).
-   **Streaming**: `Liquidsoap` (industry standard for radio automation) or custom FFmpeg stream.
-   **Database**: PostgreSQL (robustness) or SQLite (simplicity).
-   **AI**: LangChain (orchestration), OpenAI/Anthropic (LLM), ElevenLabs (TTS).
