# Online Radio DJ - System Design Document

## 1. Executive Summary
The **Online Radio DJ** is an autonomous, AI-driven internet radio station platform. It replaces legacy desktop automation tools (like RoboDJ) with a modern, web-based, cloud-native architecture. It integrates seamlessly with the "AI Music Agents" ecosystem to broadcast AI-generated music alongside human-curated tracks, hosted by dynamic AI personalities.

## 2. Architecture Overview

### A. Core Components
1.  **Frontend (Next.js)**:
    -   **Dashboard**: Manage schedules, playlists, and AI host personalities.
    -   **Studio View**: Real-time visualizer of the broadcast queue and audio levels.
    -   **Public Player**: Embeddable web player for listeners.
2.  **Backend (Python FastAPI)**:
    -   **Scheduler Engine**: Determines what plays next (Music vs. Talk).
    -   **Content Manager**: CRUD for Tracks, Prompts, and Ad/Promo spots.
    -   **Agent Orchestrator**: Manages the "DJ Agent" lifecycle.
3.  **Audio Pipeline (Python/FFmpeg/Liquidsoap)**:
    -   **Streamer**: Generates the continuous audio stream (Icecast/HLS).
    -   **Mixer**: Handles crossfades, ducking (lowering music volume during speech), and FX.
    -   **Synthesizer**: Interfacing with TTS providers (ElevenLabs, OpenAI).

### B. Integration with AI Music Agents
-   **Source Material**: Automatically ingests tracks generated by the `Composer` and `Producer` agents.
-   **Metadata**: Reads rich metadata (Mood, BPM, Key, Genre) to inform DJ scripts and transitions.
-   **Live Interaction**: The DJ Agent can "interview" the Musician Agents about their new tracks.

## 3. Detailed Modules

### 3.1. The DJ Agent ("Host")
*A specialized agent responsible for the "Voice" of the station.*

-   **Persona Profile**:
    -   `Name`, `Backstory`, `VoiceID`, `Tone` (e.g., "Hype", "Chill", "NPR-style").
    -   `Knowledge Base`: Access to artist bios, song facts, weather, and news.
-   **Scripting Engine (LLM)**:
    -   Generates "Links" (speech between songs).
    -   **Input**: Previous Song, Next Song, Station ID, Current Time, Weather, Listener Requests.
    -   **Output**: Natural language script with SSML tags for emotional inflection.

### 3.2. Scheduler & Playlist Manager
*The "Brain" that decides the programming.*

-   **Clock Wheels**: Define templates for an hour (e.g., "Top of Hour ID" -> "Power Hit" -> "DJ Link" -> "New Release").
-   **Rules Engine**:
    -   *Artist Separation*: "Don't play the same artist within 60 minutes."
    -   *Tempo Flow*: "Gradually increase BPM from 6 PM to 9 PM."

### 3.3. Streaming Server
*The "Mouth" that broadcasts to the world.*

-   **Protocol**: HLS (HTTP Live Streaming) for low-latency web playback, or Icecast for compatibility.
-   **Transcoding**: Real-time encoding to AAC/MP3.
-   **Metadata Push**: Updates "Now Playing" info on the frontend.

## 4. Data Model (Draft Schema)

### Tracks (Contract v2)

**Purpose**: canonical payload exchanged between ingestion, scheduling, and frontend clients.

#### Required fields
- `id` (string, UUID v4)
- `title` (string, 1-200 chars)
- `artist` (string, 1-200 chars)
- `duration` (integer, seconds, `> 0`)
- `file_path` (string, required path/URI)
- `publish_status` (enum: `draft | review | published | archived`)
- `availability` (enum: `private | geo_limited | public`)

#### Nullable (optional) fields
- `intro_duration`, `outro_duration` (integer seconds, `>= 0`, nullable)
- `bpm` (number, `> 0`, nullable)
- `energy` (number, range `0.0-1.0`, nullable)
- `artwork_url` (string URL, nullable)
- `is_explicit` (boolean, nullable)
- `genre_tags`, `mood_tags` (string array, nullable)
- `language` (string, BCP-47 style like `en`, `en-US`, nullable)
- `lufs` (number, recommended range `-40` to `0`, nullable)
- `peak_db` (number, typically `-12` to `+3`, nullable)
- `sample_rate` (integer Hz, e.g. `44100`, `48000`, nullable)
- `codec` (string enum: `mp3 | aac | flac | wav | opus`, nullable)
- `has_intro_marker`, `has_outro_marker` (boolean, nullable)
- `analytics` (object, nullable)
  - `play_count` (integer `>= 0`)
  - `like_count` (integer `>= 0`)
  - `skip_count` (integer `>= 0`)
  - `completion_rate` (number `0.0-1.0`)

#### Validation rules
- `id` must match UUID format: `^[0-9a-fA-F-]{36}$`
- `file_path` must match one of:
  - local/relative path: `^(?:[A-Za-z]:\\|/|\./|\../).+`
  - object/blob URI: `^(?:s3|gs|azure|https?)://.+`
- `artwork_url` (if present) must be HTTP(S): `^https?://[^\s]+$`
- `genre_tags`/`mood_tags` values should be lowercase snake_case tokens (ex: `synthwave`, `late_night`)

```json
{
  "id": "uuid",
  "title": "Neon Nights",
  "artist": "AI Synthwave Collective",
  "duration": 245,
  "file_path": "s3://station-assets/tracks/neon_nights_v1.mp3",
  "publish_status": "published",
  "availability": "public",
  "intro_duration": 12,
  "outro_duration": 15,
  "bpm": 128,
  "energy": 0.8,
  "artwork_url": "https://cdn.station.fm/artwork/neon_nights.jpg",
  "is_explicit": false,
  "genre_tags": ["synthwave", "electronic"],
  "mood_tags": ["night_drive", "uplifting"],
  "language": "en",
  "lufs": -13.5,
  "peak_db": -1.0,
  "sample_rate": 44100,
  "codec": "mp3",
  "has_intro_marker": true,
  "has_outro_marker": true,
  "analytics": {
    "play_count": 1284,
    "like_count": 342,
    "skip_count": 57,
    "completion_rate": 0.91
  }
}
```

#### Example A: Minimal ingest record
```json
{
  "id": "5d2a0b1d-54f0-4974-85c4-57e7cd2f0ca7",
  "title": "Sunrise Loop",
  "artist": "LoFi Unit",
  "duration": 186,
  "file_path": "s3://ingest-bucket/tracks/2026/02/sunrise_loop.wav",
  "publish_status": "draft",
  "availability": "private"
}
```

#### Example B: Fully enriched published track
```json
{
  "id": "2f9c93e2-f131-41f3-8fc8-84d9f2c8f6d1",
  "title": "Neon Nights",
  "artist": "AI Synthwave Collective",
  "duration": 245,
  "file_path": "https://cdn.station.fm/audio/neon_nights_master.mp3",
  "publish_status": "published",
  "availability": "public",
  "intro_duration": 12,
  "outro_duration": 15,
  "bpm": 128,
  "energy": 0.8,
  "artwork_url": "https://cdn.station.fm/artwork/neon_nights.jpg",
  "is_explicit": false,
  "genre_tags": ["synthwave", "electronic", "retrowave"],
  "mood_tags": ["night_drive", "energetic", "futuristic"],
  "language": "en-US",
  "lufs": -13.7,
  "peak_db": -0.8,
  "sample_rate": 48000,
  "codec": "mp3",
  "has_intro_marker": true,
  "has_outro_marker": true,
  "analytics": {
    "play_count": 34981,
    "like_count": 9123,
    "skip_count": 1302,
    "completion_rate": 0.89
  }
}
```

### BroadcastQueue
```json
{
  "id": "uuid",
  "scheduled_time": "2023-10-27T14:00:00Z",
  "item_type": "track | voice_link | jingle",
  "item_id": "uuid",
  "status": "pending | playing | played"
}
```

## 5. Implementation Plan

### Phase 1: Core Engine (MVP)
-   [ ] Python script to generate a single "Show" (MP3 file) from a list of songs.
-   [ ] Basic LLM integration to announce song titles.
-   [ ] Simple crossfade mixing.

### Phase 2: Streaming & Scheduling
-   [ ] Implement Shoutcast/Icecast server connection.
-   [ ] Build the "Clock Wheel" scheduler logic.
-   [ ] Real-time weather/time injection.

### Phase 3: Web Integration
-   [ ] Admin Dashboard for uploading tracks and configuring DJ.
-   [ ] Public Player with "Now Playing" data.

## 6. Technology Stack Recommendations
-   **Language**: Python 3.11+ (Backend), TypeScript (Frontend).
-   **Audio Processing**: `pydub` (simple) or `ffmpeg-python` (complex).
-   **Streaming**: `Liquidsoap` (industry standard for radio automation) or custom FFmpeg stream.
-   **Database**: PostgreSQL (robustness) or SQLite (simplicity).
-   **AI**: LangChain (orchestration), OpenAI/Anthropic (LLM), ElevenLabs (TTS).
