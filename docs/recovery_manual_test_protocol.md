# Manual Test Protocol: Startup Recovery SLA

## Purpose

Define a deterministic operator test for `feature_crash_recovery_restore_lkg` that proves recovery from config corruption to ready state within 2 minutes.

## Recovery entrypoints under test

1. **Launcher gate path**
   - `RoboDJ_Launcher.bat` -> `python config\\scripts\\startup_safety.py --on-launch`
   - `startup_safety.py:launch_gate()` validates config and triggers `restore_last_known_good_config()` when validation fails.
2. **Direct manual restore path**
   - `python config/scripts/startup_safety.py --restore-last-known-good`
3. **Backup snapshot source path**
   - `config/backups/config_snapshot_YYYYMMDD_HHMMSS/` generated by `--create-backup` or successful launch gate.

## Deterministic preconditions

1. Run from repository root.
2. Ensure a valid latest snapshot exists:

```bash
python config/scripts/startup_safety.py --create-backup
```

3. Confirm baseline config validates:

```bash
python config/validate_config.py
```

## Corruption seed procedure

Use a deterministic corruption seed so failure is reproducible.

1. Edit `config/schedules.json` and replace the first `{` with `[` (invalid JSON root).
2. Save file as UTF-8 with no additional modifications.
3. Confirm invalid syntax:

```bash
python -m json.tool config/schedules.json
```

Expected: parser failure.

## Timed recovery execution

### Timestamp rules

- **Start timestamp (T0):** captured immediately before invoking launcher gate (`--on-launch` or `RoboDJ_Launcher.bat`).
- **Stop timestamp (T1):** first moment the gate reports success (`Startup safety gate passed.`) and a restore success event is present in `config/logs/startup_safety_events.jsonl`.
- **SLA pass criterion:** `T1 - T0 <= 120 seconds`.

### Run command (portable)

```bash
python - <<'PY'
import subprocess, time
start = time.time()
proc = subprocess.run(["python", "config/scripts/startup_safety.py", "--on-launch"], check=False)
elapsed = time.time() - start
print(f"elapsed_seconds={elapsed:.2f}")
raise SystemExit(proc.returncode)
PY
```

## Evidence requirements

A run is valid only when all evidence below is captured:

1. Terminal output includes:
   - `Configuration validation failed at launch:`
   - `Attempting crash recovery using last-known-good snapshot...`
   - `Recovery succeeded: restored config validates.`
   - `Startup safety gate passed.`
2. `config/logs/startup_safety_events.jsonl` contains a `restore_last_known_good` record with:
   - `status: "success"`
   - non-empty `snapshot`
   - non-empty `restored_files`
3. `elapsed_seconds` is `<= 120`.
4. Evidence row appended to the table in `config/BACKUP_RECOVERY.md`.

## Failure handling

If elapsed time is `> 120s` or restore validation fails:

1. Mark run as failed in `config/BACKUP_RECOVERY.md`.
2. Preserve terminal output and log snippet for triage.
3. Do not mark TODO recovery SLA items complete.
