# TI-039 — Task A1.3 — Add per-action approval workflows and immutable audit trail export

- **Status:** Closed
- **Owner role:** Security Architect
- **Effort:** L
- **Dependencies:** TI-002 role model; TI-003 re-auth controls; audit event schema

## Definition of done

- Per-action approval policy is documented for high-risk operations with required approver roles.
- Immutable audit trail export format, retention, and integrity guarantees are defined.
- Verification checklist covers approval enforcement and audit export integrity.

## Implementation scope (explicit in-repo targets)

- `docs/exec-plans/active/tracked-issues/TI-039.md`
  - Authoritative action catalog, approver matrix, and immutable export schema.
- `docs/exec-plans/active/2026-02-25-next-unfinished-phase-build.md`
  - Execution packet cross-links and dependency ordering validation.
- `docs/operations/subagent_execution_playbook.md`
  - Add enforcement hook for approval-chain evidence capture in stage-gated execution.
- `docs/operations/artifacts.md`
  - Define artifact retention + hash evidence requirements for audit exports.

## Action catalog + immutable audit export schema

### Action catalog (must be enforced)

| Action ID | Operation | Minimum approvers | Required role(s) | Audit criticality |
| --- | --- | --- | --- | --- |
| `ACT-PUBLISH` | Publish release/content to production channel | 1 | `release_manager` | High |
| `ACT-DELETE` | Delete runtime config/content reference | 2 | `security_architect` + `service_owner` | Critical |
| `ACT-OVERRIDE` | Override policy guardrail / emergency bypass | 2 | `incident_commander` + `security_architect` | Critical |
| `ACT-KEY-ROTATION` | Rotate active encryption key material | 1 | `security_engineer` | High |
| `ACT-CONFIG-EDIT` | Edit protected config values in controlled files | 1 | `service_owner` | High |

### Immutable audit export schema (v1)

Required exported columns/fields:

1. `event_id` (UUIDv7, unique, non-null)
2. `action_id` (one of catalog IDs above)
3. `actor_principal` (human/service principal)
4. `target_ref` (path/resource identifier)
5. `before_hash_sha256` (hex, 64 chars)
6. `after_hash_sha256` (hex, 64 chars)
7. `approval_chain` (ordered array: approver, role, decision_ts, signature_ref)
8. `decision` (`approved|denied|revoked`)
9. `event_ts_utc` (ISO-8601 UTC)
10. `export_batch_id` (traceable bundle id)

Integrity constraints:

- Export file MUST include detached digest file (`.sha256`) and line-count manifest.
- Export file naming convention: `artifacts/security/audit_exports/<yyyy-mm-dd>/<batch_id>.ndjson`.
- Retention floor: 365 days hot + 365 days cold archive pointer.

## Dependency checkpoints

- [x] `DEP-TI039-01`: TI-002 role model confirms listed roles exist and are current.
- [x] `DEP-TI039-02`: TI-003 re-auth policy maps to high-risk actions (`ACT-DELETE`, `ACT-OVERRIDE`).
- [x] `DEP-TI039-03`: Audit event schema owner signs off immutable field list + hash requirements.

## Validation commands (copy/paste runnable)

- `rg -n "ACT-(PUBLISH|DELETE|OVERRIDE|KEY-ROTATION|CONFIG-EDIT)|Immutable audit export schema" docs/exec-plans/active/tracked-issues/TI-039.md`
  - Pass signature: all 5 `ACT-*` rows and schema heading are present.
  - Fail signature: missing one or more `ACT-*` IDs or schema heading not found.
- `rg -n "DEP-TI039-0[1-3]" docs/exec-plans/active/tracked-issues/TI-039.md`
  - Pass signature: 3 dependency checkpoint IDs found.
  - Fail signature: fewer than 3 checkpoint IDs found.
- `git diff -- docs/exec-plans/active/tracked-issues/TI-039.md`
  - Pass signature: diff contains scope, schema, validation, evidence, rollback sections.
  - Fail signature: expected sections absent from diff.

## Required evidence artifacts

- Log path: `artifacts/security/logs/ti-039-approval-enforcement.log`
- Report file: `artifacts/security/reports/ti-039-immutable-audit-export.md`
- Hash output: `artifacts/security/audit_exports/<yyyy-mm-dd>/<batch_id>.sha256`
- Checklist IDs (must be checked in report):
  - `CHK-TI039-01` action catalog complete
  - `CHK-TI039-02` approver-role mapping verified
  - `CHK-TI039-03` immutable export schema fields complete
  - `CHK-TI039-04` digest + retention metadata attached

## Rollback steps

1. Revert TI-039 doc edits: `git checkout -- docs/exec-plans/active/tracked-issues/TI-039.md`.
2. Remove TI-039 generated artifacts for invalid schema/export format.
3. Re-run validation commands to confirm rollback removed `ACT-*` additions.
4. Record rollback rationale in `artifacts/security/reports/ti-039-immutable-audit-export.md` under `Rollback`.


## Closure alignment record

- TI-039 action catalog and approval-chain evidence enforcement is now codified in `docs/operations/subagent_execution_playbook.md` stage gates (`GATE-HR-01..05`).
- Audit export bundle contract (`.ndjson`, `.sha256`, `.linecount`) and retention floor are codified in `docs/operations/artifacts.md`.
- Verification template now requires `CHK-TI039-01..04` and dependency evidence (`DEP-TI039-01..03`) with explicit TI-002/TI-003 linkage for `ACT-DELETE`/`ACT-OVERRIDE`.
- Undefined fields are disallowed for approval-chain evidence and export bundle metadata in the stage-gate payload contract.
