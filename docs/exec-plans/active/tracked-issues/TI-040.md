# TI-040 — Task A2.2 — Add config-at-rest encryption for high-risk fields in JSON configs

- **Status:** Open
- **Owner role:** Security Engineer
- **Effort:** L
- **Dependencies:** High-risk field inventory; key management workflow from TI-004

## Definition of done

- High-risk JSON fields are classified and mapped to encryption requirements.
- Encryption/decryption workflow is documented with key-handling constraints.
- Validation procedure confirms encrypted-at-rest storage and safe rollback.

## Implementation scope (explicit in-repo targets)

- `docs/exec-plans/active/tracked-issues/TI-040.md`
  - Canonical high-risk field inventory and envelope/provenance requirements.
- `config/schedules.json`
  - Target for encrypted-at-rest sensitive values (values only; no structural mutation).
- `config/prompt_variables.json`
  - Target for encrypted-at-rest sensitive values (values only; no structural mutation).
- `docs/operations/artifacts.md`
  - Evidence storage contract for encryption report and key provenance proof.
- `CONFIG_VALIDATION.md`
  - Cross-reference command-level validation expectations.

## High-risk field inventory + encryption envelope/key provenance

### High-risk field inventory (minimum set)

| Field ref | Risk reason | Required control |
| --- | --- | --- |
| `config/prompt_variables.json:openai_api_key` | Credential secret | Encrypt at rest + redact in logs |
| `config/prompt_variables.json:tts_api_key` | Credential secret | Encrypt at rest + redact in logs |
| `config/schedules.json:webhook_auth_token` | External trigger auth | Encrypt at rest + rotate quarterly |
| `config/schedules.json:stream_fallback_password` | Privileged fallback path | Encrypt at rest + dual-control rotation |
| `config/schedules.json:remote_ingest_secret` | Inbound integration trust | Encrypt at rest + provenance tracking |

### Encryption envelope (v1)

```json
{
  "enc_v": "v1",
  "alg": "AES-256-GCM",
  "kid": "kms://dgn-dj/config/<key-id>",
  "nonce_b64": "...",
  "ciphertext_b64": "...",
  "tag_b64": "...",
  "aad": {
    "field_ref": "config/prompt_variables.json:openai_api_key",
    "env": "prod",
    "issued_at": "2026-02-25T00:00:00Z"
  }
}
```

### Key provenance requirements

- `kid` MUST resolve to approved key registry entry owned by Security Engineer.
- Provenance record MUST include key creation ticket, rotation ticket, and approver principal.
- Keys used for TI-040 fields MUST have export disabled and rotation interval <= 90 days.

## Dependency checkpoints

- [ ] `DEP-TI040-01`: TI-004 key management workflow approved for envelope `kid` format.
- [ ] `DEP-TI040-02`: TI-039 audit schema accepts `before_hash_sha256`/`after_hash_sha256` for encrypted-field edits.
- [ ] `DEP-TI040-03`: Config owners confirm target fields exist in current production config values.

## Validation commands (copy/paste runnable)

- `python -m json.tool config/schedules.json > /tmp/schedules.validated.json && python -m json.tool config/prompt_variables.json > /tmp/prompt_variables.validated.json`
  - Pass signature: both commands exit 0 with formatted JSON output files.
  - Fail signature: JSON decode error for either config file.
- `rg -n "openai_api_key|tts_api_key|webhook_auth_token|stream_fallback_password|remote_ingest_secret|enc_v|AES-256-GCM|kid" docs/exec-plans/active/tracked-issues/TI-040.md`
  - Pass signature: all inventory keys and envelope controls found.
  - Fail signature: one or more required keys/controls missing.
- `rg -n "DEP-TI040-0[1-3]" docs/exec-plans/active/tracked-issues/TI-040.md`
  - Pass signature: 3 dependency checkpoint IDs found.
  - Fail signature: fewer than 3 checkpoint IDs found.

## Required evidence artifacts

- Log path: `artifacts/security/logs/ti-040-config-encryption.log`
- Report file: `artifacts/security/reports/ti-040-high-risk-field-inventory.md`
- Hash output: `artifacts/security/hashes/ti-040-config-before-after.sha256`
- Checklist IDs (must be checked in report):
  - `CHK-TI040-01` high-risk inventory reviewed
  - `CHK-TI040-02` envelope schema validated (`enc_v`, `alg`, `kid`, `nonce`, `ciphertext`, `tag`)
  - `CHK-TI040-03` key provenance evidence attached
  - `CHK-TI040-04` encrypted-at-rest verification complete

## Rollback steps

1. Restore previous encrypted-field documentation: `git checkout -- docs/exec-plans/active/tracked-issues/TI-040.md`.
2. Revert any pending value-level encryption changes from `config/schedules.json` and `config/prompt_variables.json` using backup copies.
3. Re-run JSON validation to verify restored files are syntactically valid.
4. Mark rollback outcome and cause in `artifacts/security/reports/ti-040-high-risk-field-inventory.md`.
