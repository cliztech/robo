# TI-041 — Task A3.1 — Add security smoke script (authN/authZ checks, lockout checks)

- **Status:** Complete
- **Owner role:** QA Engineer
- **Effort:** M
- **Dependencies:** Role matrix from TI-002; timeout/re-auth policy from TI-003; approval enforcement from TI-039; encrypted config controls from TI-040

## Definition of done

- Security smoke command set is implemented for authN/authZ and lockout checks.
- Script inputs/outputs, deterministic pass/fail signatures, and artifact locations are defined for pre-release execution.
- TI-039 approval enforcement and TI-040 encrypted-config behavior are explicit gate checks.
- Results are required evidence for release readiness review.

## Implementation scope (explicit in-repo targets)

- `scripts/ci/security_smoke_check.mjs`
  - Canonical TI-041 smoke runner and deterministic artifact generator.
- `package.json`
  - Exposes smoke workflow via `pnpm test:security`.
- `docs/exec-plans/active/tracked-issues/TI-041.md`
  - Canonical smoke command matrix + pass/fail signatures + escalation map.
- `docs/exec-plans/active/2026-02-25-next-unfinished-phase-build.md`
  - Dependency ordering and packet handoff references.
- `docs/operations/agent_execution_commands.md`
  - Integrate TI-041 smoke command matrix into pre-release command runbook.
- `docs/operations/artifacts.md`
  - Define required evidence artifact paths for security smoke execution.

## Security smoke command matrix (authN/authZ/lockout)

| Scenario ID | Command | Expected pass signature | Expected fail signature |
| --- | --- | --- | --- |
| `SMK-AUTHN-01` | `pnpm test:security -- --case authn-invalid-password` | Exit code `0` + `AUTHN_DENIED_EXPECTED` + `HTTP_401_OBSERVED` | Exit non-zero, missing markers, or `AUTHN_UNEXPECTED_SUCCESS` |
| `SMK-AUTHZ-01` | `pnpm test:security -- --case authz-role-deny` | Exit code `0` + `AUTHZ_DENIED_EXPECTED` + `HTTP_403_OBSERVED` + `CONTROL_TI040_ENCRYPTED_CONFIG_DENIED` | Exit non-zero, missing markers, or `AUTHZ_UNEXPECTED_ALLOW` |
| `SMK-LOCKOUT-01` | `pnpm test:security -- --case lockout-threshold` | Exit code `0` + `LOCKOUT_TRIGGERED` + `LOCKOUT_WINDOW_ACTIVE` + `HTTP_423_OBSERVED` | Exit non-zero, missing markers, or `LOCKOUT_NOT_TRIGGERED` |
| `SMK-PRIV-01` | `pnpm test:security -- --case privileged-action-block` | Exit code `0` + `PRIV_ACTION_BLOCKED` + `CONTROL_TI039_APPROVAL_ENFORCED` + `CONTROL_TI040_ENCRYPTED_CONFIG_DENIED` | Exit non-zero, missing markers, `PRIV_ACTION_EXECUTED`, or missing TI-039/TI-040 control markers |

## Dependency checkpoints

- [x] `DEP-TI041-01`: TI-002 role matrix confirms denied-role scenarios in `SMK-AUTHZ-01`.
- [x] `DEP-TI041-02`: TI-003 lockout/re-auth thresholds reflected in `SMK-LOCKOUT-01` assertions.
- [x] `DEP-TI041-03`: TI-039 action catalog + `approval_chain` markers are required in privileged-action checks.
- [x] `DEP-TI041-04`: TI-040 encrypted-field controls are required in authorization-denial paths.

## Escalation mapping (failure routing)

| Failure source | Release gate action | Incident/security route |
| --- | --- | --- |
| `SMK-AUTHN-01` or `SMK-LOCKOUT-01` fails | Mark pre-release security gate **FAIL** and block sign-off in `PRE_RELEASE_CHECKLIST.md` | Execute first-response steps in `docs/reliability_incident_response.md` as P1/P2 depending impact |
| `SMK-AUTHZ-01` fails | Block release at pre-release security gate and require role-matrix remediation before rerun | Route to `RB-022 Unauthorized settings action` in `docs/runbooks/index.md` |
| `SMK-PRIV-01` fails with missing TI-039 markers | Block release; approval enforcement gate is unsatisfied | Route to `RB-022 Unauthorized settings action` + SecOps review |
| `SMK-AUTHZ-01` or `SMK-PRIV-01` fails with missing TI-040 markers | Block release; encrypted-config governance gate is unsatisfied | Route to `RB-020 Secret exposure suspicion` + SecOps review |

## Validation commands (copy/paste runnable)

- `pnpm test:security`
  - Pass signature: all 4 scenarios return PASS markers and artifacts are emitted in canonical paths.
  - Fail signature: non-zero exit, missing markers, unknown case, or missing TI-039/TI-040 controls.
- `pnpm test:security -- --case privileged-action-block`
  - Pass signature: `PRIV_ACTION_BLOCKED` + `CONTROL_TI039_APPROVAL_ENFORCED` + `CONTROL_TI040_ENCRYPTED_CONFIG_DENIED`.
  - Fail signature: `PRIV_ACTION_EXECUTED` or missing control markers.
- `rg -n "SMK-AUTHN-01|SMK-AUTHZ-01|SMK-LOCKOUT-01|SMK-PRIV-01" docs/exec-plans/active/tracked-issues/TI-041.md`
  - Pass signature: all 4 scenario IDs present.
  - Fail signature: one or more scenario IDs missing.

## Required evidence artifacts

- Log path: `artifacts/security/logs/ti-041-security-smoke.log`
- Report file: `artifacts/security/reports/ti-041-smoke-matrix-report.md`
- Hash output: `artifacts/security/hashes/ti-041-smoke-output.sha256`
- Checklist IDs (must be checked in report):
  - `CHK-TI041-01` authN denial scenario validated
  - `CHK-TI041-02` authZ denial scenario validated
  - `CHK-TI041-03` lockout threshold/window validated
  - `CHK-TI041-04` privileged action blocked without required approval chain

## Command examples

- Full matrix: `pnpm test:security`
- Single-scenario repro: `pnpm test:security -- --case authz-role-deny`
- Artifact integrity: `sha256sum artifacts/security/logs/ti-041-security-smoke.log`

Cross-reference required release/security gates before sign-off:

- `PRE_RELEASE_CHECKLIST.md` (pre-release security gate)
- `SECURITY.md` (security ownership + triage policy)
- `docs/runbooks/index.md` (`RB-020`, `RB-022`, `RB-023`)

## Reproducibility criteria (completion gate)

TI-041 stays complete only if all are true on rerun:

1. `pnpm test:security` returns exit `0`.
2. `artifacts/security/logs/ti-041-security-smoke.log` contains identical scenario IDs and marker tokens.
3. `artifacts/security/reports/ti-041-smoke-matrix-report.md` checklist IDs `CHK-TI041-01..04` are all checked.
4. `artifacts/security/hashes/ti-041-smoke-output.sha256` matches current log.

## Rollback steps

1. Revert TI-041 workflow/docs edits: `git checkout -- scripts/ci/security_smoke_check.mjs package.json docs/exec-plans/active/tracked-issues/TI-041.md`.
2. Remove invalid smoke evidence artifacts from `artifacts/security/logs`, `artifacts/security/reports`, and `artifacts/security/hashes`.
3. Re-run validation commands to confirm matrix/checkpoint sections and artifacts were removed by rollback.
4. Capture rollback rationale and remediations in `artifacts/security/reports/ti-041-smoke-matrix-report.md`.
